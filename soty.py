# -*- coding: utf-8 -*-
"""Untitled28.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ohf_6EWp5Zoi2R6HT8R77Jr9y3g9VuOG
"""

import pandas as pd
import numpy as np
from datetime import datetime, timedelta

def soty_etl_pipeline(raw_file_path):
    try:
        df = pd.read_csv(raw_file_path)
        print(f"Loaded {len(df)} rows.")
    except FileNotFoundError:
        print(f"Error: File '{raw_file_path}' not found.")
        return

    drop_cols = ['StandardHours', 'Over18', 'EmployeeCount']
    df.drop(columns=[c for c in drop_cols if c in df.columns], inplace=True)

    df.drop_duplicates(subset=['EmployeeNumber'], inplace=True)

    reference_date = pd.to_datetime('2023-12-31')

    if 'YearsAtCompany' in df.columns:
        df['HireDate'] = reference_date - pd.to_timedelta(df['YearsAtCompany'] * 365.25, unit='D')
    else:
        df['HireDate'] = reference_date

    if 'Attrition' in df.columns:
        df['TerminationDate'] = np.where(df['Attrition'] == 'Yes', reference_date, pd.NaT)
        df['TerminationDate'] = pd.to_datetime(df['TerminationDate'])

    df['Tenure'] = np.where(
        df['TerminationDate'].notnull(),
        (df['TerminationDate'] - df['HireDate']).dt.days / 365.25,
        (reference_date - df['HireDate']).dt.days / 365.25
    )
    df['Tenure'] = df['Tenure'].round(1)

    conditions_age = [
        (df['Age'] < 26),
        (df['Age'] >= 26) & (df['Age'] < 36),
        (df['Age'] >= 36) & (df['Age'] < 46),
        (df['Age'] >= 46) & (df['Age'] < 56),
        (df['Age'] >= 56)
    ]
    choices_age = ['18-25', '26-35', '36-45', '46-55', '55+']
    df['Age Group'] = np.select(conditions_age, choices_age, default='Unknown')

    if 'MonthlyIncome' in df.columns:
        conditions_inc = [
            (df['MonthlyIncome'] < 5000),
            (df['MonthlyIncome'] >= 5000) & (df['MonthlyIncome'] < 10000),
            (df['MonthlyIncome'] >= 10000) & (df['MonthlyIncome'] < 15000),
            (df['MonthlyIncome'] >= 15000)
        ]
        choices_inc = ['<5k', '5k-10k', '10k-15k', '15k+']
        df['Income Range'] = np.select(conditions_inc, choices_inc, default='Unknown')

    edu_map = {1: 'Below College', 2: 'College', 3: 'Bachelor', 4: 'Master', 5: 'Doctor'}
    if 'Education' in df.columns:
        df['Education Label'] = df['Education'].map(edu_map)

    sat_map = {1: 'Low', 2: 'Medium', 3: 'High', 4: 'Very High'}
    if 'JobSatisfaction' in df.columns:
        df['Satisfaction Label'] = df['JobSatisfaction'].map(sat_map)

    df.sort_values(by='EmployeeNumber', ascending=True, inplace=True)

    cols_master = ['EmployeeNumber', 'Age', 'Gender', 'MaritalStatus',
                   'HireDate', 'TerminationDate', 'Attrition', 'Tenure', 'Age Group']
    master_df = df[[c for c in cols_master if c in df.columns]].copy()

    cols_salary = ['EmployeeNumber', 'MonthlyIncome', 'PercentSalaryHike',
                   'StockOptionLevel', 'Income Range']
    salary_df = df[[c for c in cols_salary if c in df.columns]].copy()

    cols_job = ['EmployeeNumber', 'JobRole', 'JobLevel', 'Education',
                'EducationField', 'Education Label']
    job_df = df[[c for c in cols_job if c in df.columns]].copy()

    cols_dept = ['EmployeeNumber', 'Department', 'BusinessTravel', 'DistanceFromHome']
    dept_df = df[[c for c in cols_dept if c in df.columns]].copy()

    cols_survey = ['EmployeeNumber', 'PerformanceRating', 'JobSatisfaction',
                   'EnvironmentSatisfaction', 'Satisfaction Label']
    survey_df = df[[c for c in cols_survey if c in df.columns]].copy()

    master_df.to_csv('employee_master_fixed.csv', index=False)
    salary_df.to_csv('salary.csv', index=False)
    job_df.to_csv('job_info.csv', index=False)
    dept_df.to_csv('department.csv', index=False)
    survey_df.to_csv('employee_survey_data.csv', index=False)

    print("Success: 5 files generated.")

if __name__ == "__main__":
    try:
        soty_etl_pipeline('HR_Employee_Attrition.csv')
    except:
        pass